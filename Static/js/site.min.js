function GetMap(){map=new atlas.Map("demoMap",{center:userPosition,zoom:16,pitch:60,showBuildingModels:!0,view:"Auto",authOptions:{authType:"anonymous",clientId:"e6b6ab59-eb5d-4d25-aa57-581135b927f0",getToken:function(n){fetch("https://samples.azuremaps.com/api/GetAzureMapsToken").then(n=>n.text()).then(t=>n(t))}}});resultsPanel=document.getElementById("results-panel");searchInput=document.getElementById("search-input");searchInput.addEventListener("keyup",searchInputKeyup);locateMeButton=document.getElementById("locate-me-button");locateMeButton.addEventListener("click",locateMe);popup=new atlas.Popup;var n=atlas.service.MapsURL.newPipeline(new atlas.service.MapControlCredential(map));routeURL=new atlas.service.RouteURL(n);searchURL=new atlas.service.SearchURL(n);map.events.add("ready",function(){var n;datasource=new atlas.source.DataSource;map.sources.add(datasource);var t=new atlas.layer.SymbolLayer(datasource,null,{iconOptions:{image:"marker-darkblue",anchor:"center",allowOverlap:!0},filter:["==","type","POI"]}),r=new atlas.layer.LineLayer(datasource,null,{strokeColor:"rgb(108, 50, 255)",strokeWidth:5,filter:["any",["==",["geometry-type"],"LineString"],["==",["geometry-type"],"MultiLineString"]]}),i=new atlas.layer.SymbolLayer(datasource,null,{iconOptions:{image:"pin-round-red",anchor:"center",allowOverlap:!0},filter:["==","layer","routePoint"]}),u=new atlas.layer.PolygonLayer(datasource,null,{fillColor:"rgba(0, 153, 255, 0.5)",filter:["==","layer","locateMe"]}),f=new atlas.layer.SymbolLayer(datasource,null,{iconOptions:{image:"marker-red",anchor:"center",allowOverlap:!0},filter:["==","layer","locateMe"]});map.layers.add([i,r,u,f,t]);map.events.add("click",t,function(n){n.shapes&&n.shapes.length>0&&showPopupPOI(n.shapes[0])});map.events.add("click",i,function(n){n.shapes&&n.shapes.length>0&&showPopupRoutePoint(n.shapes[0])});n=new atlas.drawing.DrawingManager(map,{interactionType:"click",toolbar:new atlas.control.DrawingToolbar({position:"top-right"})});map.events.add("drawingstarted",n,()=>{n.getOptions().interactionType==="click"&&map.setUserInteraction({dragPanInteraction:!0})});map.controls.add(new atlas.control.StyleControl({mapStyles:["road","road_shaded_relief","grayscale_light","night","grayscale_dark","satellite","satellite_road_labels","high_contrast_dark"]}),{position:"top-right"});map.controls.add(new atlas.control.TrafficControl,{position:"top-right"});map.controls.add(new atlas.control.TrafficLegendControl,{position:"bottom-left"});map.controls.add(new atlas.control.ZoomControl,{position:"top-right"});map.controls.add(new atlas.control.PitchControl,{position:"top-right"});map.controls.add(new atlas.control.CompassControl,{position:"top-right"})})}function clearSerach(){resultsPanel.innerHTML="";datasource.clear();popup.close()}function locateMe(){var n=document.getElementById("locate-me-icon"),t=document.getElementById("locate-me-spinner");clearSerach();searchInput.value="";locateMeButton.disabled=!0;n.style.display="none";t.style.display="block";navigator.geolocation.getCurrentPosition(function(i){userPosition=[i.coords.longitude,i.coords.latitude];var r=new atlas.data.Point(userPosition);datasource.add(new atlas.data.Feature(r,{layer:"locateMe",subType:"Circle",radius:i.coords.accuracy}));map.setCamera({center:userPosition,zoom:15,pitch:0});userPositionUpdated=!0;locateMeButton.disabled=!1;n.style.display="block";t.style.display="none"},function(i){switch(i.code){case i.PERMISSION_DENIED:alert("User denied the request for Geolocation.");break;case i.POSITION_UNAVAILABLE:alert("Position information is unavailable.");break;case i.TIMEOUT:alert("The request to get user position timed out.");break;case i.UNKNOWN_ERROR:alert("The request to get user position has an unknown error.")}locateMeButton.disabled=!1;n.style.display="block";t.style.display="none"})}function searchInputKeyup(n){centerMapOnResults=!1;searchInput.value.length>=minSearchInputLength?(n.keyCode===13&&(centerMapOnResults=!0),setTimeout(function(){searchInputLength===searchInput.value.length&&search()},keyStrokeDelay)):resultsPanel.innerHTML="";searchInputLength=searchInput.value.length}function search(){clearSerach();var n=searchInput.value;searchURL.searchPOI(atlas.service.Aborter.timeout(1e4),n,{lon:map.getCamera().center[0],lat:map.getCamera().center[1],maxFuzzyLevel:4,view:"Auto"}).then(n=>{var i=n.geojson.getFeatures(),u,r,t;for(datasource.add(i),centerMapOnResults&&map.setCamera({bounds:i.bbox}),u="",r=0;r<i.features.length;r++)t=i.features[r],u+=`<a href="#" class="list-group-item list-group-item-action d-flex gap-3 py-3" aria-current="true" onclick="itemClicked('${t.id}')" onmouseover="itemHovered('${t.id}')"><svg class="flex-shrink-0" width="2.0em" height="2.0em"><use xlink:href="#geo-icon"/></svg><div class="d-flex gap-2 w-100 justify-content-between"><div><h6 class="mb-0">${t.properties.poi.name}</h6><p class="mb-0 opacity-75">${t.properties.address.freeformAddress}</p></div><small class="opacity-50 text-nowrap">${t.properties.dist.toFixed()} m</small></div></a>`;resultsPanel.innerHTML=u})}function itemHovered(n){var t=datasource.getShapeById(n);showPopupPOI(t)}function itemClicked(n){var t=datasource.getShapeById(n),i=t.getCoordinates();map.setCamera({center:i,zoom:16})}function addressClicked(n){var t=datasource.getShapeById(n),i=t.getCoordinates(),r=userPosition;routeURL.calculateRouteDirections(atlas.service.Aborter.timeout(1e4),[r,i],{maxAlternatives:0,instructionsType:"text",traffic:!0}).then(n=>{var i,u,f,c,l,r,t,o,s,h,y;if(n&&n.routes&&n.routes.length>0){for(i=n.routes[0],u=[],f=0;f<i.legs.length;f++)c=i.legs[f],l=c.points.map(function(n){return[n.longitude,n.latitude]}),u=u.concat(l);routeLine=new atlas.data.LineString(u);datasource.add(routeLine);map.setCamera({bounds:atlas.data.BoundingBox.fromData(routeLine),padding:80});var e=[],a=[],v=0,p=Math.min(i.guidance.instructions.length,60);for(r=0;r<p;r++){if(t=i.guidance.instructions[r],t.layer="routePoint",o=Math.round(t.travelTimeInSeconds/60),o>120)break;s=[t.point.longitude,t.point.latitude];e.push(new atlas.data.Feature(new atlas.data.Point(s),t));r<i.guidance.instructions.length-1&&(h=i.guidance.instructions[r+1],v=Math.round(atlas.math.getHeading(s,[h.point.longitude,h.point.latitude])));a.push(`${t.point.latitude},${t.point.longitude},${o},${v}`)}y=weatherAlongRouteUrl.replace("{query}",a.join(":"));processRequest(y).then(n=>{if(n&&n.waypoints&&n.waypoints.length===e.length){for(var t=0,i=n.waypoints.length;t<i;t++)Object.assign(e[t].properties,n.waypoints[t]);datasource.add(e)}})}});popup.close(map)}function truckClicked(n){var t=datasource.getShapeById(n),i=t.getCoordinates(),r=userPosition;routeURL.calculateRouteDirections(atlas.service.Aborter.timeout(1e4),[r,i],{traffic:!0,travelMode:"truck"}).then(()=>{var n=directions.geojson.getFeatures();datasource.add(n)});popup.close(map)}function showPopupPOI(n){var t,i;(popup.close(),t=n.getProperties(),t&&t.poi)&&(t.poi.phone||(t.poi.phone=""),t.poi.url||(t.poi.url=""),i=`<div class="card" style="width:420px;"><div class="card-header"><h5 class="card-title">${t.poi.name}</h5></div><div class="card-body"><div class="list-group"><a href="#" onclick="addressClicked('${n.data.id}')" class="list-group-item list-group-item-action d-flex gap-3 py-3" aria-current="true"><svg width="32" height="32" class="flex-shrink-0"><use xlink:href="#cursor-icon"/></svg><div class="d-flex gap-2 w-100 justify-content-between"><div><h6 class="mb-0">Address</h6><p class="mb-0 opacity-75">${t.address.freeformAddress}</p></div></div></a><a target="_blank" href="tel:${t.poi.phone.replace(/\s/g,"")}" class="list-group-item list-group-item-action d-flex gap-3 py-3 ${t.poi.phone===""?"visually-hidden":""}" aria-current="true"><svg width="32" height="32" class="flex-shrink-0"><use xlink:href="#phone-icon"/></svg><div class="d-flex gap-2 w-100 justify-content-between"><div><h6 class="mb-0">Phone</h6><p class="mb-0 opacity-75">${t.poi.phone}</p></div></div></a><a target="_blank" href="https://${t.poi.url.replace(/^https?\:\/\//i,"")}" class="list-group-item list-group-item-action d-flex gap-3 py-3 ${t.poi.url===""?"visually-hidden":""}" aria-current="true"><svg width="32" height="32" class="flex-shrink-0"><use xlink:href="#link-icon"/></svg><div class="d-flex gap-2 w-100 justify-content-between"><div><h6 class="mb-0">Website</h6><p class="mb-0 opacity-75">${t.poi.url.replace(/^https?\:\/\//i,"")}</p></div></div></a></div></div><div class="card-footer text-muted">${t.dist.toFixed()} meters away from ${userPositionUpdated===!0?"you":"the Tower of London"}</div></div>`,popup.setOptions({position:n.getCoordinates(),content:i}),popup.open(map))}function showPopupRoutePoint(n){var t,i;(popup.close(),t=n.getProperties(),t)&&(t.street||(t.street="Directions & Weather"),i=`<div class="card" style="width:380px;"><div class="card-header"><h5 class="card-title">${t.street}</h5></div><div class="card-body"><img class="weather-icon" src="/images/icons/weather-black/${t.iconCode}.png"/><div class="weather-content"><div class="weather-temp">${t.temperature.value}&#176;${t.temperature.unit}</div>Wind: ${t.wind.speed.value} ${t.wind.speed.unit}<div class="weather-phrase">${t.shortPhrase}</div>Clouds: ${t.cloudCover}&#37</div></div><div class="card-footer text-muted">${t.message}</div></div>`,popup.setOptions({position:n.getCoordinates(),content:i}),popup.open(map))}function processRequest(n){return new Promise((t,i)=>{n=n.replace("{azMapsDomain}",atlas.getDomain());var r=map.authentication.signRequest({url:n}),u=map.getServiceOptions().tranformRequest;u&&(r=u(n));fetch(r.url,{method:"GET",mode:"cors",headers:new Headers(r.headers)}).then(n=>n.json(),n=>i(n)).then(n=>{t(n)},n=>i(n))})}var map,datasource,popup,searchInput,locateMeButton,resultsPanel,searchInputLength,centerMapOnResults,routeURL,searchURL,userPosition=[-.076083,51.50812],userPositionUpdated=!1,weatherAlongRouteUrl="https://{azMapsDomain}/weather/route/json?api-version=1.0&query={query}",minSearchInputLength=3,keyStrokeDelay=250;