function GetMap(){map=new atlas.Map("demoMap",{center:userPosition,zoom:16,pitch:60,showBuildingModels:!0,view:"Auto",authOptions:{authType:"anonymous",clientId:"e6b6ab59-eb5d-4d25-aa57-581135b927f0",getToken:function(n){fetch("https://samples.azuremaps.com/api/GetAzureMapsToken").then(n=>n.text()).then(t=>n(t))}}});resultsPanel=document.getElementById("results-panel");searchInput=document.getElementById("search-input");searchInput.addEventListener("keyup",searchInputKeyup);locateMeButton=document.getElementById("locate-me-button");locateMeButton.addEventListener("click",locateMe);popup=new atlas.Popup;var n=atlas.service.MapsURL.newPipeline(new atlas.service.MapControlCredential(map));routeURL=new atlas.service.RouteURL(n);searchURL=new atlas.service.SearchURL(n);map.events.add("ready",function(){var t,i,r,u,f,n;datasource=new atlas.source.DataSource;map.sources.add(datasource);t="data:image/svg+xml;base64,"+btoa('<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="#517CED" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 1a3 3 0 1 0 0 6 3 3 0 0 0 0-6zM4 4a4 4 0 1 1 4.5 3.969V13.5a.5.5 0 0 1-1 0V7.97A4 4 0 0 1 4 3.999zm2.493 8.574a.5.5 0 0 1-.411.575c-.712.118-1.28.295-1.655.493a1.319 1.319 0 0 0-.37.265.301.301 0 0 0-.057.09V14l.002.008a.147.147 0 0 0 .016.033.617.617 0 0 0 .145.15c.165.13.435.27.813.395.751.25 1.82.414 3.024.414s2.273-.163 3.024-.414c.378-.126.648-.265.813-.395a.619.619 0 0 0 .146-.15.148.148 0 0 0 .015-.033L12 14v-.004a.301.301 0 0 0-.057-.09 1.318 1.318 0 0 0-.37-.264c-.376-.198-.943-.375-1.655-.493a.5.5 0 1 1 .164-.986c.77.127 1.452.328 1.957.594C12.5 13 13 13.4 13 14c0 .426-.26.752-.544.977-.29.228-.68.413-1.116.558-.878.293-2.059.465-3.34.465-1.281 0-2.462-.172-3.34-.465-.436-.145-.826-.33-1.116-.558C3.26 14.752 3 14.426 3 14c0-.599.5-1 .961-1.243.505-.266 1.187-.467 1.957-.594a.5.5 0 0 1 .575.411z" /><\/svg>');map.imageSprite.add("geo-icon",t);i="data:image/svg+xml;base64,"+btoa('<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="#04257C" viewBox="0 0 16 16"><path d="M7 1.414V4H2a1 1 0 0 0-1 1v4a1 1 0 0 0 1 1h5v6h2v-6h3.532a1 1 0 0 0 .768-.36l1.933-2.32a.5.5 0 0 0 0-.64L13.3 4.36a1 1 0 0 0-.768-.36H9V1.414a1 1 0 0 0-2 0zM12.532 5l1.666 2-1.666 2H2V5h10.532z" /><\/svg>');map.imageSprite.add("signpost-icon",i);r="data:image/svg+xml;base64,"+btoa('<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="#862A6F" viewBox="0 0 16 16"><path d="M7 7V1.414a1 1 0 0 1 2 0V2h5a1 1 0 0 1 .8.4l.975 1.3a.5.5 0 0 1 0 .6L14.8 5.6a1 1 0 0 1-.8.4H9v10H7v-5H2a1 1 0 0 1-.8-.4L.225 9.3a.5.5 0 0 1 0-.6L1.2 7.4A1 1 0 0 1 2 7h5zm1 3V8H2l-.75 1L2 10h6zm0-5h6l.75-1L14 3H8v2z" /><\/svg>');map.imageSprite.add("signpost2-icon",r);u="data:image/svg+xml;base64,"+btoa('<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="#424F85" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M15.817.113A.5.5 0 0 1 16 .5v14a.5.5 0 0 1-.402.49l-5 1a.502.502 0 0 1-.196 0L5.5 15.01l-4.902.98A.5.5 0 0 1 0 15.5v-14a.5.5 0 0 1 .402-.49l5-1a.5.5 0 0 1 .196 0L10.5.99l4.902-.98a.5.5 0 0 1 .415.103zM10 1.91l-4-.8v12.98l4 .8V1.91zm1 12.98 4-.8V1.11l-4 .8v12.98zm-6-.8V1.11l-4 .8v12.98l4-.8z" /><\/svg>');map.imageSprite.add("map-icon",u);f="data:image/svg+xml;base64,"+btoa('<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="#C85EAE" viewBox="0 0 16 16"><path d="M8 16.016a7.5 7.5 0 0 0 1.962-14.74A1 1 0 0 0 9 0H7a1 1 0 0 0-.962 1.276A7.5 7.5 0 0 0 8 16.016zm6.5-7.5a6.5 6.5 0 1 1-13 0 6.5 6.5 0 0 1 13 0z" /><path d="m6.94 7.44 4.95-2.83-2.83 4.95-4.949 2.83 2.828-4.95z" /><\/svg>');map.imageSprite.add("compass-icon",f);var e=new atlas.layer.SymbolLayer(datasource,null,{iconOptions:{image:"geo-icon",anchor:"center",allowOverlap:!0},filter:["==","type","POI"]}),o=new atlas.layer.SymbolLayer(datasource,null,{iconOptions:{image:"signpost-icon",anchor:"center",allowOverlap:!0},filter:["any",["==","type","Street"],["==","type","Point Address"]]}),s=new atlas.layer.SymbolLayer(datasource,null,{iconOptions:{image:"map-icon",anchor:"center",allowOverlap:!0},filter:["==","type","Address Range"]}),h=new atlas.layer.SymbolLayer(datasource,null,{iconOptions:{image:"compass-icon",anchor:"center",allowOverlap:!0},filter:["==","type","Geography"]}),c=new atlas.layer.SymbolLayer(datasource,null,{iconOptions:{image:"signpost2-icon",anchor:"center",allowOverlap:!0},filter:["==","type","Cross Street"]}),a=new atlas.layer.LineLayer(datasource,null,{strokeColor:"rgb(108, 50, 255)",strokeWidth:5,filter:["any",["==",["geometry-type"],"LineString"],["==",["geometry-type"],"MultiLineString"]]}),l=new atlas.layer.SymbolLayer(datasource,null,{iconOptions:{image:"pin-round-red",anchor:"center",allowOverlap:!0},filter:["==","layer","routePoint"]}),v=new atlas.layer.PolygonLayer(datasource,null,{fillColor:"rgba(0, 153, 255, 0.5)",filter:["==","layer","locateMe"]}),y=new atlas.layer.SymbolLayer(datasource,null,{iconOptions:{image:"marker-red",anchor:"center",allowOverlap:!0},filter:["==","layer","locateMe"]});map.layers.add([y,v,e,o,s,h,c,l,a]);map.events.add("click",e,function(n){n.shapes&&n.shapes.length>0&&showPopupPOI(n.shapes[0])});map.events.add("click",o,function(n){n.shapes&&n.shapes.length>0&&showPopupPOI(n.shapes[0])});map.events.add("click",s,function(n){n.shapes&&n.shapes.length>0&&showPopupPOI(n.shapes[0])});map.events.add("click",h,function(n){n.shapes&&n.shapes.length>0&&showPopupPOI(n.shapes[0])});map.events.add("click",c,function(n){n.shapes&&n.shapes.length>0&&showPopupPOI(n.shapes[0])});map.events.add("click",l,function(n){n.shapes&&n.shapes.length>0&&showPopupRoutePoint(n.shapes[0])});n=new atlas.drawing.DrawingManager(map,{interactionType:"click",toolbar:new atlas.control.DrawingToolbar({position:"bottom-right"})});map.events.add("drawingstarted",n,()=>{n.getOptions().interactionType==="click"&&map.setUserInteraction({dragPanInteraction:!0})});map.controls.add(new atlas.control.StyleControl({mapStyles:["road","road_shaded_relief","grayscale_light","night","grayscale_dark","satellite","satellite_road_labels","high_contrast_dark"]}),{position:"top-right"});map.controls.add(new atlas.control.TrafficControl,{position:"top-right"});map.controls.add(new atlas.control.TrafficLegendControl,{position:"bottom-left"});map.controls.add(new atlas.control.ZoomControl,{position:"top-right"});map.controls.add(new atlas.control.PitchControl,{position:"top-right"});map.controls.add(new atlas.control.CompassControl,{position:"top-right"})})}function clearSerach(){resultsPanel.innerHTML="";datasource.clear();popup.close()}function locateMe(){var n=document.getElementById("locate-me-icon"),t=document.getElementById("locate-me-spinner");clearSerach();searchInput.value="";locateMeButton.disabled=!0;n.style.display="none";t.style.display="block";navigator.geolocation.getCurrentPosition(function(i){userPosition=[i.coords.longitude,i.coords.latitude];var r=new atlas.data.Point(userPosition);datasource.add(new atlas.data.Feature(r,{layer:"locateMe",subType:"Circle",radius:i.coords.accuracy}));map.setCamera({center:userPosition,zoom:15,pitch:0,bearing:0});userPositionUpdated=!0;locateMeButton.disabled=!1;n.style.display="block";t.style.display="none"},function(){alert("User position information is unavailable!");locateMeButton.disabled=!1;n.style.display="block";t.style.display="none"})}function searchInputKeyup(n){centerMapOnResults=!1;searchInput.value.length>=minSearchInputLength?(n.keyCode===13&&(centerMapOnResults=!0),setTimeout(function(){searchInputLength===searchInput.value.length&&search()},keyStrokeDelay)):resultsPanel.innerHTML="";searchInputLength=searchInput.value.length}function search(){clearSerach();var n=searchInput.value;searchURL.searchFuzzy(atlas.service.Aborter.timeout(1e4),n,{lon:map.getCamera().center[0],lat:map.getCamera().center[1],maxFuzzyLevel:3,view:"Auto"}).then(n=>{var u=n.geojson.getFeatures(),e,f;for(datasource.add(u),centerMapOnResults&&map.setCamera({bounds:u.bbox}),e="",f=0;f<u.features.length;f++){var t=u.features[f],i="map-icon",r="Location",o=t.properties.dist<1?0:(t.properties.dist/1e3).toFixed(1);switch(t.properties.type){case"POI":i="geo-icon";r=t.properties.poi.name;break;case"Street":case"Point Address":i="signpost-icon";r=t.properties.address.streetName;break;case"Geography":i="compass-icon";r=t.properties.address.country;break;case"Address Range":i="map-icon";r="Address Range";break;case"Cross Street":i="signpost2-icon";r=t.properties.address.streetName}e+=`<a href="#" class="list-group-item list-group-item-action d-flex gap-3 py-3" aria-current="true" onclick="itemClicked('${t.id}')" onmouseover="itemHovered('${t.id}')">
                    <svg class="flex-shrink-0" width="2.0em" height="2.0em"><use xlink:href="#${i}" /></svg>
                    <div class="d-flex gap-2 w-100 justify-content-between">
                        <div>
                            <h6 class="mb-0">${r}</h6>
                            <p class="mb-0 opacity-75">${t.properties.address.freeformAddress}</p></div>
                            <small class="opacity-50 text-nowrap">${o} km</small>
                        </div>
                </a>`}resultsPanel.innerHTML=e})}function itemClicked(n){var t=datasource.getShapeById(n),i=t.getCoordinates();map.setCamera({center:i,zoom:16});showPopupPOI(t)}function itemHovered(n){var t=datasource.getShapeById(n);showPopupPOI(t)}function addressClicked(n){var t=datasource.getShapeById(n),i=t.getCoordinates(),r=userPosition;routeURL.calculateRouteDirections(atlas.service.Aborter.timeout(1e4),[r,i],{maxAlternatives:0,instructionsType:"text",traffic:!0}).then(n=>{var t=n.geojson.getFeatures();datasource.add(t)});popup.close(map)}function truckClicked(n){var t=datasource.getShapeById(n),i=t.getCoordinates(),r=userPosition;routeURL.calculateRouteDirections(atlas.service.Aborter.timeout(1e4),[r,i],{traffic:!0,travelMode:"truck"}).then(n=>{var t=n.geojson.getFeatures();datasource.add(t)});popup.close(map)}async function showPopupPOI(n){popup.close();var t=n.getProperties(),e=n.getCoordinates(),r="Location",o=t.dist<1?0:(t.dist/1e3).toFixed(1),u="",f="";switch(t.type){case"POI":r=t.poi.name;t.poi.phone&&(u=t.poi.phone);t.poi.url&&(f=t.poi.url);break;case"Street":case"Point Address":case"Cross Street":r=t.address.streetName;break;case"Geography":r=t.address.country;break;case"Address Range":r="Address Range"}var s=weatherUrl.replace("{query}",e[1]+","+e[0]),i=await processRequest(s).then(n=>n&&n.results&&n.results[0]?n.results[0]:null),h=`<div class="card" style="width:420px;">
                <div class="card-header">
                    <h5 class="card-title">${r}</h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        <a href="#" onclick="addressClicked('${n.data.id}')" class="list-group-item list-group-item-action d-flex gap-3 py-3" aria-current="true">
                            <svg width="32" height="32" class="flex-shrink-0"><use xlink:href="#cursor-icon" /></svg>
                            <div class="d-flex gap-2 w-100 justify-content-between">
                                <div>
                                    <h6 class="mb-0">Address</h6>
                                    <p class="mb-0 opacity-75">${t.address.freeformAddress}</p>
                                </div>
                            </div>
                        </a>
                        <a target="_blank" href="tel:${u.replace(/\s/g,"")}" class="list-group-item list-group-item-action d-flex gap-3 py-3 ${u===""?"visually-hidden":""}" aria-current="true">
                            <svg width="32" height="32" class="flex-shrink-0"><use xlink:href="#phone-icon" /></svg>
                            <div class="d-flex gap-2 w-100 justify-content-between">
                                <div>
                                    <h6 class="mb-0">Phone</h6>
                                    <p class="mb-0 opacity-75">${u}</p>
                                </div>
                            </div>
                        </a>
                        <a target="_blank" href="http://${f.replace(/^https?\:\/\//i,"")}" class="list-group-item list-group-item-action d-flex gap-3 py-3 ${f===""?"visually-hidden":""}" aria-current="true">
                            <svg width="32" height="32" class="flex-shrink-0"><use xlink:href="#link-icon" /></svg>
                            <div class="d-flex gap-2 w-100 justify-content-between">
                                <div>
                                    <h6 class="mb-0">Website</h6>
                                    <p class="mb-0 opacity-75">${f.replace(/^https?\:\/\//i,"")}</p>
                                </div>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action d-flex gap-3 py-3 ${i?"":"visually-hidden"}" aria-current="true">
                            <img width="32" height="32" class="flex-shrink-0" src="/images/icons/weather-black/${i.iconCode}.png"/>
                            <div class="d-flex gap-2 w-100 justify-content-between">
                                <div>
                                    <h6 class="mb-0">${i.phrase}</h6>
                                    <p class="mb-0 opacity-75">Temperature: ${i.temperature.value}&#176;${i.temperature.unit}, Wind: ${i.wind.speed.value} ${i.wind.speed.unit}, Clouds: ${i.cloudCover}&#37</p>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
                <div class="card-footer text-muted">
                    ${o} km away from ${userPositionUpdated===!0?"you":"the Tower of London"}
                </div>
            </div>`;popup.setOptions({position:e,content:h});popup.open(map)}function showPopupRoutePoint(n){var t,i;(popup.close(),t=n.getProperties(),t)&&(t.street||(t.street="Directions & Weather"),i=`<div class="card" style="width:380px;"><div class="card-header"><h5 class="card-title">${t.street}</h5></div><div class="card-body"><img class="weather-icon" src="/images/icons/weather-black/${t.iconCode}.png"/><div class="weather-content"><div class="weather-temp">${t.temperature.value}&#176;${t.temperature.unit}</div>Wind: ${t.wind.speed.value} ${t.wind.speed.unit}<div class="weather-phrase">${t.shortPhrase}</div>Clouds: ${t.cloudCover}&#37</div></div><div class="card-footer text-muted">${t.message}</div></div>`,popup.setOptions({position:n.getCoordinates(),content:i}),popup.open(map))}function processRequest(n){return new Promise((t,i)=>{n=n.replace("{azMapsDomain}",atlas.getDomain());var r=map.authentication.signRequest({url:n}),u=map.getServiceOptions().tranformRequest;u&&(r=u(n));fetch(r.url,{method:"GET",mode:"cors",headers:new Headers(r.headers)}).then(n=>n.json(),n=>i(n)).then(n=>{t(n)},n=>i(n))})}var map,datasource,popup,searchInput,locateMeButton,resultsPanel,searchInputLength,centerMapOnResults,routeURL,searchURL,userPosition=[-.076083,51.50812],userPositionUpdated=!1,weatherUrl="https://{azMapsDomain}/weather/currentConditions/json?api-version=1.1&query={query}",airQualityUrl="https://{azMapsDomain}/weather/airQuality/current/json?api-version=1.1&query={query}",minSearchInputLength=3,keyStrokeDelay=250;